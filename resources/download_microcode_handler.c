
void r_maybe_handle_download_microcode(void)

{
  byte bVar1;
  ushort uVar2;
  int iVar3;
  uint __next_offset;
  uint curr_bytes_to_copy;
  uint current_offset;
  uint some_index;
  uint higher_bound_fw_offset;
  uint lower_bound_fw_offset;
  ushort *puVar4;
  uint __subcommand;
  
  bVar1 = DAT_ram_5000a088._3_1_;
  current_offset = 0;
  lower_bound_fw_offset = 0;
  higher_bound_fw_offset = 0x606;
  if (DAT_ram_8007dfeb == '\0') {
    if (DAT_ram_8007dfea != '\0') {
      lower_bound_fw_offset = 0xc0c;
      higher_bound_fw_offset = 0x1212;
    }
  }
  else {
    lower_bound_fw_offset = 0x606;
    higher_bound_fw_offset = 0xc0c;
  }
  DAT_ram_10005fe8 = 0;
  if (DAT_ram_5000a088._2_1_ == -0x6e) {
    g_is_pio = 1;
  }
  else {
    if ((DAT_ram_5000a088._2_1_ == -0x6d) && (DAT_ram_10005e5c == '\x02')) {
      DAT_ram_10005fe8 = 1;
      current_offset = 1;
      goto LAB_ram_80024b66;
    }
    if (DAT_ram_5000a088._2_1_ == -0x6d) {
      g_is_pio = 0;
    }
  }
  DAT_ram_10005fe7 = DAT_ram_5000a088._2_1_;
  __subcommand = (uint)DAT_ram_5000a088._3_1_;
  if (((__subcommand == 0x3 || __subcommand == 0x7) || __subcommand == 0xe) || __subcommand == 0xf)
  {
    uVar2 = g_next_offset;
    if (__subcommand != 0xf) {
      FUN_ram_8005b650();
      FUN_ram_00007b14(0x85,1,1,__subcommand,0,0,0);
      g_blocks_to_transfer = (uint)CONCAT11((undefined)g_block_count,g_lba_low);
      if (g_blocks_to_transfer == 0) {
        r_maybe_complete_transaction();
        return;
      }
      if (__subcommand == 0x7) {
        if (DAT_ram_10005e5c == '\x02') {
          DAT_ram_10005fe8 = 1;
          current_offset = 1;
          goto LAB_ram_80024b66;
        }
        if (g_blocks_to_transfer != 0x1212) {
          g_next_offset = 0;
          g_blocks_copied = 0;
          DAT_ram_10005fe8 = 2;
          current_offset = 2;
          goto LAB_ram_80024b66;
        }
        __next_offset = 0x1212;
        g_next_offset = 0x1212;
      }
      else {
        current_offset = (uint)CONCAT11(g_block_count._2_1_,g_block_count._1_1_);
        if (current_offset == 0) {
          g_blocks_copied = 0;
          __next_offset = g_blocks_to_transfer;
          g_next_offset = CONCAT11((undefined)g_block_count,g_lba_low);
        }
        else {
          if ((current_offset != g_next_offset) || (__subcommand != g_last_subcommand)) {
            g_next_offset = 0;
            g_blocks_copied = 0;
            DAT_ram_10005fe8 = 2;
            current_offset = 2;
            goto LAB_ram_80024b66;
          }
          __next_offset = g_blocks_to_transfer + current_offset & 0xffff;
          g_next_offset = (ushort)(g_blocks_to_transfer + current_offset);
        }
        g_last_subcommand = bVar1;
      }
      puVar4 = &g_next_offset;
      if (0x1212 < __next_offset) {
        g_next_offset = 0;
        DAT_ram_10005fe8 = 3;
        iVar3 = 3;
LAB_ram_80024e08:
        g_blocks_copied = 0;
        FUN_ram_00007b14(0x85,0,1,iVar3,0,0,0);
        FUN_ram_80023480(4);
        return;
      }
      DAT_ram_5000a0bf = DAT_ram_5000a0bf | 0x80;
      r_maybe_receive_from_port(0x40000000,g_blocks_to_transfer << 9,0);
      DAT_ram_10005ce0 = 1;
      DAT_ram_10000600 = 2;
      g_lba_low = (uint8_t)g_blocks_to_transfer;
      DAT_ram_5000a095 = (undefined)(g_blocks_to_transfer >> 8);
      FUN_ram_80024758(2,0);
      DAT_ram_5000a05c = DAT_ram_5000a05c & 0xfef81fef;
      DAT_ram_500007fd = DAT_ram_500007fd & 0xe7;
      DAT_ram_1000651d = '\0';
      if ((DAT_ram_10000624 & 0xfc) != 0) {
        *puVar4 = 0;
        DAT_ram_10005fe8 = 4;
        iVar3 = 4;
        goto LAB_ram_80024e08;
      }
      DAT_ram_50001807 = DAT_ram_50001807 | 1;
      DAT_ram_5000a680 = DAT_ram_5000a680 & 0xfd;
      DAT_ram_5000a06c = 1;
joined_r0x80024e4c:
      if (0x200 < g_blocks_to_transfer) {
        __next_offset = (uint)*puVar4;
        do {
                    /* look for an "empty" entry or something like that */
          some_index = 0;
          while (*(int *)(&DAT_ram_50000400 + some_index * 4) == L'\xffffffff') {
            some_index = some_index + 1 & 0xffff;
            if (0xf < some_index) {
              if ((g_blocks_copied == 0) && (lower_bound_fw_offset <= __next_offset)) {
                curr_bytes_to_copy = (__next_offset - lower_bound_fw_offset) * 0x200;
                some_index = 0x200 - (__next_offset - lower_bound_fw_offset) & 0xffff;
              }
              else {
                curr_bytes_to_copy = 0x40000;
                    /* Exactly 0x200 blocks */
                some_index = 0;
              }
              if (higher_bound_fw_offset <= __next_offset) {
                curr_bytes_to_copy =
                     curr_bytes_to_copy + (__next_offset - higher_bound_fw_offset) * -0x200;
              }
              if ((lower_bound_fw_offset <= __next_offset) &&
                 (current_offset < higher_bound_fw_offset)) {
                r_maybe_some_efficient_data_transfer
                          (1,some_index * 0x200 + 0x40000000,
                           &g_download_buffer + (uint)g_blocks_copied * 0x200,curr_bytes_to_copy,0,1
                          );
                g_blocks_copied = g_blocks_copied + (short)(curr_bytes_to_copy >> 9);
              }
              DAT_ram_500007fd = DAT_ram_500007fd & 0xe7;
              current_offset = current_offset + 0x200 & 0xffff;
              g_blocks_to_transfer = g_blocks_to_transfer - 0x200;
              goto joined_r0x80024e4c;
            }
          }
        } while( true );
      }
      FUN_ram_80023424(0xd1);
      if (DAT_ram_1000651d != '\0') {
        DAT_ram_1000651d = '\0';
        DAT_ram_100061b4 = DAT_ram_100061b4 + -1;
        do {
        } while (DAT_ram_100061b4 != 0);
      }
      DAT_ram_5000a0bc = DAT_ram_5000a0bc & 0x7f;
      DAT_ram_5000a05c = DAT_ram_5000a05c & 0xfff81fef | 0x1000000;
      DAT_ram_10005ce0 = 0;
      __next_offset = (uint)*puVar4;
      if ((g_blocks_copied == 0) && (lower_bound_fw_offset <= __next_offset)) {
        curr_bytes_to_copy = g_blocks_to_transfer - (__next_offset - lower_bound_fw_offset) & 0xffff
        ;
        some_index = __next_offset - lower_bound_fw_offset;
      }
      else {
        curr_bytes_to_copy = 0;
        some_index = g_blocks_to_transfer;
      }
      some_index = some_index * 0x200;
      if (higher_bound_fw_offset <= __next_offset) {
        some_index = some_index + (__next_offset - higher_bound_fw_offset) * -0x200;
      }
      if ((lower_bound_fw_offset <= __next_offset) && (current_offset < higher_bound_fw_offset)) {
        r_maybe_some_efficient_data_transfer
                  (1,curr_bytes_to_copy * 0x200 + 0x40000000,
                   &g_download_buffer + (uint)g_blocks_copied * 0x200,some_index,0,1);
        g_blocks_copied = g_blocks_copied + (short)(some_index >> 9);
      }
      DAT_ram_500007fd = DAT_ram_500007fd & 0xe7;
      if ((DAT_ram_10000624 & 0xfc) != 0) {
        *puVar4 = 0;
        DAT_ram_10005fe8 = 4;
        iVar3 = 4;
        goto LAB_ram_80024e08;
      }
      uVar2 = *puVar4;
      if (*puVar4 < 0x1212) {
        g_lba_low = '\x01';
        r_maybe_complete_transaction();
        uVar2 = *puVar4;
      }
    }
    if (uVar2 == 0x1212) {
      if (__subcommand != 0xf) {
        FUN_ram_00005dc4();
        current_offset = Auxregs0120;
        Auxregs0120 = current_offset | 1;
        r_maybe_some_efficient_data_transfer(3,&g_download_buffer,DAT_ram_1000638c,0xc0c00,0,1);
        r_maybe_some_efficient_memset(&g_download_buffer,0xc0c00,0,1);
        current_offset = Auxregs0120;
        Auxregs0120 = current_offset & 0xfffffffe;
        iVar3 = FUN_ram_8006673c(1);
        if (((DAT_ram_10000624 & 0xfc) != 0) || (iVar3 == 0)) {
          g_next_offset = 0;
          g_blocks_copied = 0;
          current_offset = (uint)DAT_ram_10005fe8;
LAB_ram_80024b66:
          FUN_ram_00007b14(0x85,0,1,current_offset,0,0,0);
          FUN_ram_80023480(4);
          return;
        }
        FUN_ram_00007b14(0x85,2,0,0,0,0,0);
      }
      if (__subcommand == 0xe) {
        g_lba_low = '\x03';
      }
      else if (__subcommand != 0x7) {
        g_lba_low = '\x02';
      }
      if (DAT_ram_10005d6a != 0) {
        FUN_ram_8003f990(0x2c);
      }
      if (__subcommand != 0xe) {
        DAT_ram_5000a064 = DAT_ram_5000a064 & 0xfffffcff | 0x300;
        g_next_offset = 0;
        g_blocks_copied = 0;
        DAT_ram_5000a088._2_1_ = DAT_ram_10005fe7;
        DAT_ram_5000008c = DAT_ram_5000008c | 0x80;
        r_maybe_activate_microcode(0);
      }
      r_maybe_complete_transaction();
      goto LAB_ram_800251c2;
    }
    if (__subcommand != 0xf) goto LAB_ram_800251c2;
    g_next_offset = 0;
    g_blocks_copied = 0;
    r_maybe_some_efficient_memset(&g_download_buffer,0xc0c00,0,1);
    DAT_ram_10005fe8 = 2;
    iVar3 = 2;
  }
  else {
    DAT_ram_10005fe8 = 1;
    iVar3 = 1;
  }
  FUN_ram_00007b14(0x85,0,1,iVar3,0,0,0);
  FUN_ram_80023480(4);
LAB_ram_800251c2:
  if (DAT_ram_10005d6a != 0) {
    FUN_ram_8003f990(0x2c,0,0);
  }
  return;
}

