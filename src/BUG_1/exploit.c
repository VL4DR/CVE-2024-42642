#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <libatafw/libatafw.h>
#include "common.h"

#define BUG1_BUFFER_SIZE					(0x1 * LIBATAFW_SECTOR_SIZE)

void print_buffer(const uint8_t *buffer, uint32_t buffer_size)
{
	uint32_t i = 0;

	for (i = 0; i < buffer_size; i++) {
		printf("%02x\n", buffer[i]);
	}
}

int main(int argc, char *argv[])
{
	int main_ret = MAIN_RESULT_FAILURE;
	enum ata_fw_error status = ATA_FW_ERR_UNINITIALIZED;
	void *dummy_buffer = NULL;
	uint8_t sense_buffer[LIBATAFW_SENSE_BUFFER_LENGTH];

	if (NUM_MAIN_ARGS != argc) {
		printf("Usage: %s <device path>\n", argv[0]);
		goto l_cleanup;
	}

	memset(sense_buffer, 0, sizeof(sense_buffer));

	status = libatafw__init(argv[1]);
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: could not initialize libatafw. Initialization returned: %d\n", status);
		goto l_cleanup;
	}

	dummy_buffer = calloc(BUG1_BUFFER_SIZE, sizeof(uint8_t));
	if (NULL == dummy_buffer) {
		printf("Error: allocating dummy buffer failed!\n");
		goto l_cleanup;
	}

	status = libatafw__enqueue_firmware_chunk(0, dummy_buffer, BUG1_BUFFER_SIZE * sizeof(uint8_t));
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: could not enqueue a firmware chunk. libatafw returned: %d\n", status);
		goto l_cleanup;
	}

	status = libatafw__execute_requests(false, NULL, sense_buffer);
	if (ATA_FW_ERR_SUCCESS != status) {
		printf("Error: an error encountered while executing the request. libatafw status: %d\n", status);
		print_buffer(sense_buffer, sizeof(sense_buffer));
		goto l_cleanup;
	}

	main_ret = MAIN_RESULT_SUCCESS;
l_cleanup:
	if (NULL != dummy_buffer) {
		free(dummy_buffer);
	}

	libatafw__deinit();

	return main_ret;
}
